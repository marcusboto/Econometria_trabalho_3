"0",""
"0","CUTOFF_BAIXO <- 22  # Financia turma adicional"
"0","CUTOFF_ALTO <- 28   # Exige nova turma"
"0",""
"0","# 1. Criar variável com duas categorias"
"0","Maimonides_italia <- Maimonides_italia %>%"
"0","  mutate("
"0","    categoria = case_when("
"0","      clsize_hat < CUTOFF_BAIXO ~ ""Abaixo de 22"","
"0","      clsize_hat >= CUTOFF_BAIXO & clsize_hat < CUTOFF_ALTO ~ ""Entre 22 e 28"","
"0","    )"
"0","  )"
"0",""
"0","# 2. Scatterplot agrupado"
"0","dados_plot <- Maimonides_italia %>%"
"0","  group_by(clsize_hat) %>%"
"0","  summarise("
"0","    mean_score = mean(answers_math_std, na.rm = TRUE),"
"0","    categoria = first(categoria),"
"0","    .groups = ""drop"""
"0","  )"
"0",""
"0","# 3. Regressões para CADA segmento"
"0",""
"0","# Segmento 1: Abaixo de 22"
"0","if (sum(Maimonides_italia$categoria == ""Abaixo de 22"", na.rm = TRUE) > 10) {"
"0","  reg_abaixo22 <- lm(answers_math_std ~ clsize_hat,"
"0","                     data = Maimonides_italia %>% "
"0","                       filter(categoria == ""Abaixo de 22""))"
"0","} else {"
"0","  reg_abaixo22 <- NULL"
"0","}"
"0",""
"0","# Segmento 2: Menor que 28"
"0","if (sum(Maimonides_italia$categoria == ""Entre 22 e 28"", na.rm = TRUE) > 10) {"
"0","  reg_entre22_28 <- lm(answers_math_std ~ clsize_hat,"
"0","                       data = Maimonides_italia %>% "
"0","                         filter(categoria == ""Entre 22 e 28""))"
"0","} else {"
"0","  reg_entre22_28 <- NULL"
"0",""
"0","}"
"0",""
"0","# 4. LINHAS DE PREDIÇÃO (FALTANDO NO SEU CÓDIGO)"
"0","# Abaixo de 22"
"0","if (!is.null(reg_abaixo22)) {"
"0","  linha_abaixo <- data.frame("
"0","    clsize_hat = seq("
"0","      min(dados_plot$clsize_hat[dados_plot$categoria == ""Abaixo de 22""]),"
"0","      CUTOFF_BAIXO - 0.1,"
"0","      length.out = 100"
"0","    )"
"0","  )"
"0","  linha_abaixo$pred <- predict(reg_abaixo22, newdata = linha_abaixo)"
"0","} else {"
"0","  linha_abaixo <- NULL"
"0","}"
"0",""
"0","# Menor que 28"
"0","if (!is.null(reg_entre22_28)) {"
"0","  linha_entre <- data.frame("
"0","    clsize_hat = seq("
"0","      CUTOFF_BAIXO,"
"0","      CUTOFF_ALTO - 0.1,"
"0","      length.out = 100"
"0","    )"
"0","  )"
"0","  linha_entre$pred <- predict(reg_entre22_28, newdata = linha_entre)"
"0","} else {"
"0","  linha_entre <- NULL"
"0","}"
"0",""
"0",""
"0","# 5. Gráfico com DOIS cutoffs"
"0","p <- ggplot() +"
"0","  # Pontos coloridos por categoria"
"0","  geom_point(data = dados_plot,"
"0","             aes(x = clsize_hat, y = mean_score, color = categoria),"
"0","             alpha = 0.5, size = 2) +"
"0","  "
"0","  # Linhas verticais dos DOIS cutoffs"
"0","  geom_vline(xintercept = c(CUTOFF_BAIXO, CUTOFF_ALTO),"
"0","             linetype = ""dashed"", size = 1, alpha = 0.7, color = ""gray50"") +"
"0","  "
"0","  # Anotações"
"0","  annotate(""text"", x = CUTOFF_BAIXO, y = max(dados_plot$mean_score),"
"0","           label = ""Cutoff = 22"", hjust = 1.1, vjust = 1, "
"0","           size = 4, fontface = ""bold"") +"
"0","  "
"0","  annotate(""text"", x = CUTOFF_ALTO, y = max(dados_plot$mean_score),"
"0","           label = ""Cutoff = 28"", hjust = -0.1, vjust = 1,"
"0","           size = 4, fontface = ""bold"") +"
"0","  "
"0","  # Estética"
"0","  labs(title = ""RDD com Dois Cutoffs: Notas vs Tamanho Predito"","
"0","       subtitle = ""Regra italiana: 22 (financiamento) e 28 (obrigatório)"","
"0","       x = ""Tamanho Predito da Turma (clsize_hat)"","
"0","       y = ""Nota média (answers_math_std)"","
"0","       color = ""Faixa de tamanho"") +"
"0","  scale_color_manual(values = c(""Abaixo de 22"" = ""#1f77b4"","
"0","                                ""Entre 22 e 28"" = ""#ff7f0e"","
"0","                                ""28 ou mais"" = ""#2ca02c"")) +"
"0","  theme_minimal()"
"0",""
"0","# 6. Adicionar linhas de regressão "
"0","if (!is.null(linha_abaixo)) {"
"0","  p <- p + geom_line(data = linha_abaixo,"
"0","                     aes(x = clsize_hat, y = pred),"
"0","                     color = ""#1f77b4"", size = 1.2)"
"0","}"
"0",""
"0","if (!is.null(linha_entre)) {"
"0","  p <- p + geom_line(data = linha_entre,"
"0","                     aes(x = clsize_hat, y = pred),"
"0","                     color = ""#ff7f0e"", size = 1.2)"
"0","}"
"0",""
"0",""
"0","print(p)"
